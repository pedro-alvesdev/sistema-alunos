<!doctype html>
<html lang="pt-BR" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciador de Alunos de Laborat√≥rio</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    .toast { position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #10b981; }
    input:checked + .slider:before { transform: translateX(26px); }
    .progress-bar { width: 100%; background-color: #e2e8f0; border-radius: 999px; height: 8px; overflow: hidden; }
    .progress-fill { height: 100%; transition: width 0.3s ease; }
  </style>
</head>
<body class="h-full">
  <div id="app" class="w-full h-full overflow-auto bg-gradient-to-br from-indigo-50 to-blue-50"></div>

  <script>
    // --- CONFIGURA√á√ÉO SUPABASE ---
    const SUPABASE_URL = 'https://nuhkdkiukqrlhdvnaiel.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_2Rd5khY_SUm3vBA3u5ZsHw_ps50tcTK';
    const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- ESTADO ---
    let allStudents = [];
    let allAttendances = [];
    let filteredStudents = [];
    let isAuthenticated = false;
    let currentUser = 'admin';
    let currentScreen = 'management';
    let selectedDate = new Date();
    let selectedStudentsForAssign = new Set();

    // --- CARREGAMENTO ---
    async function refreshData() {
        const { data: st } = await _supabase.from('students').select('*');
        const { data: at } = await _supabase.from('attendance').select('*');
        allStudents = st || [];
        allAttendances = at || [];
        
        if(currentScreen === 'management') {
            updateFilterOptions('management');
            applyFilters();
        } else {
            updateFilterOptions('attendance');
            applyAttendanceFilters();
        }
    }

    // --- LOGIN ---
    function showLoginScreen() {
      const app = document.getElementById('app');
      app.style.background = `#0f172a`;
      app.innerHTML = `
        <div class="w-full h-full flex items-center justify-center">
          <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4 border border-slate-700">
            <div class="text-center mb-8">
              <div class="mb-6 flex justify-center">
                <div class="w-20 h-20 bg-blue-600 rounded-full flex items-center justify-center shadow-lg shadow-blue-900/50">
                    <span class="text-white text-4xl">üîê</span>
                </div>
              </div>
              <h1 class="text-2xl font-bold text-white mb-2">Acesso Restrito</h1>
              <p class="text-slate-400">Gerenciador de Alunos Laborat√≥rio</p>
            </div>
            <form id="login-form" class="space-y-6">
              <input type="password" id="access-code" required maxlength="6" class="w-full p-4 border-2 border-slate-600 rounded-lg text-center text-2xl bg-slate-900 text-white font-mono outline-none focus:border-blue-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
              <button type="submit" class="w-full py-4 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-500 transition-all">üîì Acessar</button>
            </form>
            <div id="login-error" class="hidden mt-4 p-3 rounded-lg text-center bg-red-500/20 text-red-400">‚ùå C√≥digo incorreto.</div>
          </div>
        </div>`;

      document.getElementById('login-form').onsubmit = async (e) => {
        e.preventDefault();
        if(document.getElementById('access-code').value === '123456') {
            isAuthenticated = true;
            sessionStorage.setItem('isAuth', 'true');
            await refreshData();
            renderManagementScreen();
        } else {
            document.getElementById('login-error').classList.remove('hidden');
        }
      };
    }

    // --- TELAS ---
    function renderManagementScreen() {
      const app = document.getElementById('app');
      app.style.background = `linear-gradient(135deg, #0f172a, #1e293b)`;
      app.innerHTML = `
        <div class="min-h-full p-4 md:p-8">
          <div class="max-w-7xl mx-auto">
            ${renderNav()}
            
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 mb-6">
              <h2 class="text-white font-bold mb-4 flex items-center gap-2">üì• Importar Planilha <span class="text-xs font-normal text-slate-400">(Sede, Serie, Turno, Curso, Nome_Turma, RA, Nome_Aluno)</span></h2>
              <div class="flex flex-col md:flex-row gap-4 items-center">
                <input type="file" id="excel-upload" class="flex-1 p-3 bg-slate-900 border-2 border-dashed border-slate-600 rounded-lg text-slate-400 w-full">
                <button onclick="handleExcelUpload()" id="upload-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-bold w-full md:w-auto">Processar</button>
              </div>
              <div id="import-progress" class="hidden mt-4">
                 <div class="progress-bar"><div id="progress-fill" class="progress-fill bg-blue-500" style="width: 0%"></div></div>
                 <p id="progress-text" class="text-slate-400 text-xs mt-2 text-center"></p>
              </div>
            </div>

            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 mb-6">
                <div class="flex justify-between items-center mb-4"><h2 class="text-white font-bold">üîç Filtros</h2> <button onclick="clearFilters()" class="text-xs text-blue-400">Limpar</button></div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    ${renderFilterDropdowns('management')}
                </div>
                <input type="text" id="search-nome" oninput="applyFilters()" placeholder="üîé Buscar por nome..." class="w-full mt-4 p-3 bg-slate-900 border border-slate-600 rounded-lg text-white outline-none focus:border-blue-500">
            </div>

            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
              <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                <h2 class="text-white font-bold text-xl">Lista de Alunos (<span id="student-count">0</span>)</h2>
                <div class="flex gap-2">
                    <button onclick="printStudentList()" class="bg-slate-700 text-white px-4 py-2 rounded text-sm">üñ®Ô∏è Imprimir</button>
                    <button onclick="openAssignModal()" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm">üè´ Atribuir Sala</button>
                    <button onclick="openModal()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm">‚ûï Adicionar</button>
                </div>
              </div>
              <div class="overflow-x-auto"><table class="w-full text-left text-slate-300"><thead class="bg-slate-900/50"><tr><th class="p-3">Nome</th><th class="p-3">RA</th><th class="p-3">Turma</th><th class="p-3 text-center">Lado/G</th><th class="p-3 text-center">A√ß√µes</th></tr></thead><tbody id="student-table"></tbody></table></div>
            </div>
          </div>
        </div>
        ${renderModals()}
      `;
      updateFilterOptions('management');
      applyFilters();
    }

    function renderAttendanceScreen() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="min-h-full p-4 md:p-8">
          <div class="max-w-7xl mx-auto">
            ${renderNav()}
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                    <h2 class="text-white font-bold mb-4">üìÖ Data</h2>
                    <input type="date" id="date-picker" onchange="changeDate(this.value)" class="w-full p-3 bg-slate-900 text-white border border-slate-600 rounded-lg">
                </div>
                <div class="lg:col-span-2 bg-slate-800 p-6 rounded-xl border border-slate-700">
                    <h2 class="text-white font-bold mb-4">üîç Filtrar Turma</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">${renderFilterDropdowns('attendance')}</div>
                </div>
            </div>
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
              <div class="flex justify-between items-center mb-6">
                <h2 class="text-white font-bold text-xl">Presen√ßa (<span id="attendance-count">0</span>)</h2>
                <button onclick="printAttendanceList()" class="bg-slate-700 text-white px-4 py-2 rounded">üñ®Ô∏è Imprimir</button>
              </div>
              <div id="attendance-list" class="space-y-3"></div>
            </div>
          </div>
        </div>`;
      document.getElementById('date-picker').value = selectedDate.toISOString().split('T')[0];
      updateFilterOptions('attendance');
      applyAttendanceFilters();
    }

    // --- COMPONENTES ---
    function renderNav() {
        return `
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <h1 class="text-2xl font-bold text-white">Laborat√≥rio de Alunos</h1>
            <div class="flex gap-2">
                <button onclick="setScreen('management')" class="px-6 py-2 rounded-lg font-bold ${currentScreen === 'management' ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-400'}">Gest√£o</button>
                <button onclick="setScreen('attendance')" class="px-6 py-2 rounded-lg font-bold ${currentScreen === 'attendance' ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-400'}">Presen√ßa</button>
                <button onclick="logout()" class="px-4 py-2 bg-slate-700 text-white rounded-lg">Sair</button>
            </div>
        </header>`;
    }

    function renderFilterDropdowns(ctx) {
        const p = ctx === 'management' ? 'filter' : 'attendance-filter';
        const fn = ctx === 'management' ? 'applyFilters()' : 'applyAttendanceFilters()';
        return `
            <select id="${p}-sede" onchange="${fn}" class="bg-slate-900 text-white p-2 rounded border border-slate-600 text-sm"><option value="todos">Sede: Todas</option></select>
            <select id="${p}-serie" onchange="${fn}" class="bg-slate-900 text-white p-2 rounded border border-slate-600 text-sm"><option value="todos">S√©rie: Todas</option></select>
            <select id="${p}-turno" onchange="${fn}" class="bg-slate-900 text-white p-2 rounded border border-slate-600 text-sm"><option value="todos">Turma: Todas</option></select>
            ${ctx === 'management' ? `<select id="filter-parte" onchange="applyFilters()" class="bg-slate-900 text-white p-2 rounded border border-slate-600 text-sm"><option value="todos">Lado: Todos</option><option value="A">Lado A</option><option value="B">Lado B</option></select>` : ''}
        `;
    }

    function renderModals() {
        return `
        <div id="modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
            <div class="bg-slate-800 p-6 rounded-2xl w-full max-w-xl border border-slate-700 text-white">
                <h2 id="modal-title" class="text-xl font-bold mb-4">Aluno</h2>
                <form id="student-form" class="grid grid-cols-2 gap-4">
                    <div class="col-span-2"><label class="text-xs text-slate-400">Nome</label><input id="m-nome" class="w-full bg-slate-900 p-2 rounded border border-slate-600"></div>
                    <div><label class="text-xs text-slate-400">RA</label><input id="m-ra" class="w-full bg-slate-900 p-2 rounded border border-slate-600"></div>
                    <div><label class="text-xs text-slate-400">Turma</label><input id="m-turma" class="w-full bg-slate-900 p-2 rounded border border-slate-600"></div>
                    <div><label class="text-xs text-slate-400">Lado</label><select id="m-lado" class="w-full bg-slate-900 p-2 rounded border border-slate-600"><option value="">Nenhum</option><option value="A">A</option><option value="B">B</option></select></div>
                    <div><label class="text-xs text-slate-400">Grupo</label><input id="m-grupo" type="number" class="w-full bg-slate-900 p-2 rounded border border-slate-600"></div>
                    <div class="col-span-2 flex gap-2 mt-4"><button type="submit" class="flex-1 bg-blue-600 py-3 rounded-lg font-bold">SALVAR</button><button type="button" onclick="closeModal()" class="flex-1 bg-slate-700 py-3 rounded-lg">CANCELAR</button></div>
                </form>
            </div>
        </div>
        <div id="assign-modal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
            <div class="bg-slate-800 p-6 rounded-2xl w-full max-w-2xl border border-slate-700 flex flex-col max-h-[90vh]">
                <h2 class="text-white font-bold text-xl mb-4">üè´ Atribui√ß√£o em Massa</h2>
                <div class="flex-1 overflow-y-auto mb-6 bg-slate-900 p-4 rounded-xl border border-slate-700" id="assign-list"></div>
                <div class="bg-slate-700/50 p-4 rounded-xl grid grid-cols-2 gap-4">
                    <div><p class="text-white text-xs mb-2">Lado:</p><div class="flex gap-1"><button onclick="massUpdate('parte_sala', 'A')" class="flex-1 bg-blue-600 text-white py-2 rounded">A</button><button onclick="massUpdate('parte_sala', 'B')" class="flex-1 bg-blue-600 text-white py-2 rounded">B</button></div></div>
                    <div><p class="text-white text-xs mb-2">Grupo:</p><div class="flex gap-1"><input id="mass-g" type="number" class="w-12 bg-slate-900 text-white p-1 rounded"><button onclick="massUpdate('grupo', document.getElementById('mass-g').value)" class="flex-1 bg-green-600 text-white py-2 rounded">OK</button></div></div>
                </div>
                <button onclick="closeAssign()" class="mt-4 text-slate-400">Fechar</button>
            </div>
        </div>`;
    }

    // --- L√ìGICA ---
    function setScreen(s) { currentScreen = s; if(s === 'management') renderManagementScreen(); else renderAttendanceScreen(); }

    function updateFilterOptions(ctx) {
        const p = ctx === 'management' ? 'filter' : 'attendance-filter';
        const sedes = [...new Set(allStudents.map(s => s.sede))].sort();
        const series = [...new Set(allStudents.map(s => s.serie))].sort();
        const turmas = [...new Set(allStudents.map(s => s.nome_turma))].sort();
        
        const populate = (id, list, label) => {
            const el = document.getElementById(p + id);
            if(el) el.innerHTML = `<option value="todos">${label}: Todas</option>` + list.map(x => `<option value="${x}">${x}</option>`).join('');
        };
        populate('-sede', sedes, 'Sede'); populate('-serie', series, 'S√©rie'); populate('-turno', turmas, 'Turma');
    }

    function applyFilters() {
        const s = document.getElementById('filter-sede').value;
        const e = document.getElementById('filter-serie').value;
        const t = document.getElementById('filter-turno').value;
        const p = document.getElementById('filter-parte').value;
        const search = document.getElementById('search-nome').value.toLowerCase();

        filteredStudents = allStudents.filter(x => {
            const mSede = s === 'todos' || x.sede === s;
            const mSerie = e === 'todos' || x.serie === e;
            const mTurma = t === 'todos' || x.nome_turma === t;
            const mParte = p === 'todos' || x.parte_sala === p;
            const mSearch = x.nome_aluno.toLowerCase().includes(search);
            return mSede && mSerie && mTurma && mParte && mSearch;
        });

        const table = document.getElementById('student-table');
        document.getElementById('student-count').innerText = filteredStudents.length;
        table.innerHTML = filteredStudents.sort((a,b)=>a.nome_aluno.localeCompare(b.nome_aluno)).map(x => `
            <tr class="border-b border-slate-700">
                <td class="p-3">${x.nome_aluno}</td>
                <td class="p-3 text-sm">${x.ra}</td>
                <td class="p-3 text-sm">${x.nome_turma}</td>
                <td class="p-3 text-center text-sm">${x.parte_sala || '-'}${x.grupo ? '/G'+x.grupo : ''}</td>
                <td class="p-3 text-center">
                    <button onclick="editS('${x.ra}')" class="text-blue-400 px-2">‚úèÔ∏è</button>
                    <button onclick="deleteS('${x.id}')" class="text-red-400 px-2">üóëÔ∏è</button>
                </td>
            </tr>`).join('');
    }

    function applyAttendanceFilters() {
        const s = document.getElementById('attendance-filter-sede').value;
        const e = document.getElementById('attendance-filter-serie').value;
        const t = document.getElementById('attendance-filter-turno').value;
        const dKey = selectedDate.toISOString().split('T')[0];

        const list = allStudents.filter(x => {
            const mSede = s === 'todos' || x.sede === s;
            const mSerie = e === 'todos' || x.serie === e;
            const mTurma = t === 'todos' || x.nome_turma === t;
            return mSede && mSerie && mTurma;
        });

        document.getElementById('attendance-count').innerText = list.length;
        const cont = document.getElementById('attendance-list');
        cont.innerHTML = list.sort((a,b)=>a.nome_aluno.localeCompare(b.nome_aluno)).map(x => {
            const att = allAttendances.find(a => a.ra === x.ra && a.data_presenca === dKey);
            const present = att ? att.presente : true;
            return `
                <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 flex justify-between items-center">
                    <div><p class="text-white font-bold">${x.nome_aluno}</p><p class="text-slate-500 text-xs">${x.nome_turma} | Lado: ${x.parte_sala || '-'}</p></div>
                    <label class="switch"><input type="checkbox" onchange="markA('${x.ra}', this.checked)" ${present ? 'checked' : ''}><span class="slider"></span></label>
                </div>`;
        }).join('');
    }

    async function markA(ra, val) {
        const d = selectedDate.toISOString().split('T')[0];
        const s = allStudents.find(x => x.ra === ra);
        await _supabase.from('attendance').upsert({ra, data_presenca: d, presente: val, nome_aluno: s.nome_aluno, nome_turma: s.nome_turma}, {onConflict: 'ra,data_presenca'});
    }

    async function handleExcelUpload() {
        const file = document.getElementById('excel-upload').files[0];
        if(!file) return;
        const btn = document.getElementById('upload-btn');
        btn.disabled = true;
        document.getElementById('import-progress').classList.remove('hidden');

        const reader = new FileReader();
        reader.onload = async (e) => {
            const data = XLSX.utils.sheet_to_json(XLSX.read(e.target.result, {type: 'array'}).Sheets[XLSX.read(e.target.result, {type: 'array'}).SheetNames[0]]);
            for(let i=0; i<data.length; i++) {
                const row = data[i];
                await _supabase.from('students').upsert({
                    sede: String(row.SEDE||''), serie: String(row.SERIE||''), turno: String(row.TURNO||''), 
                    curso: String(row.CURSO||''), nome_turma: String(row.NOME_TURMA||''), ra: String(row.RA||''), 
                    nome_aluno: String(row.NOME_ALUNO||'')
                }, {onConflict: 'ra'});
                document.getElementById('progress-fill').style.width = ((i+1)/data.length*100) + '%';
                document.getElementById('progress-text').innerText = `${i+1} / ${data.length}`;
            }
            location.reload();
        };
        reader.readAsArrayBuffer(file);
    }

    function openAssign() {
        const list = document.getElementById('assign-list');
        list.innerHTML = filteredStudents.map(x => `
            <div class="flex items-center gap-3 p-2 border-b border-slate-800 text-white">
                <input type="checkbox" onchange="this.checked ? selectedStudentsForAssign.add('${x.id}') : selectedStudentsForAssign.delete('${x.id}')">
                <span class="text-sm">${x.nome_aluno}</span>
            </div>`).join('');
        document.getElementById('assign-modal').classList.remove('hidden');
    }

    async function massUpdate(field, val) {
        if(selectedStudentsForAssign.size === 0) return alert("Selecione alunos!");
        for(let id of selectedStudentsForAssign) await _supabase.from('students').update({[field]: val}).eq('id', id);
        location.reload();
    }

    async function deleteS(id) { if(confirm("Apagar?")) { await _supabase.from('students').delete().eq('id', id); refreshData(); } }
    function editS(ra) {
        const s = allStudents.find(x => x.ra === ra);
        document.getElementById('m-nome').value = s.nome_aluno;
        document.getElementById('m-ra').value = s.ra;
        document.getElementById('m-turma').value = s.nome_turma;
        document.getElementById('m-lado').value = s.parte_sala || '';
        document.getElementById('m-grupo').value = s.grupo || '';
        document.getElementById('modal').classList.remove('hidden');
    }

    function openAssignModal() { openAssign(); }
    function closeAssign() { document.getElementById('assign-modal').classList.add('hidden'); }
    function openModal() { document.getElementById('student-form').reset(); document.getElementById('modal').classList.remove('hidden'); }
    function closeModal() { document.getElementById('modal').classList.add('hidden'); }
    function changeDate(v) { selectedDate = new Date(v); applyAttendanceFilters(); }
    function logout() { sessionStorage.clear(); location.reload(); }

    document.onload = (sessionStorage.getItem('isAuth') === 'true') ? refreshData().then(()=>renderManagementScreen()) : showLoginScreen();
    window.onload = () => { if(sessionStorage.getItem('isAuth') === 'true') { refreshData().then(()=>renderManagementScreen()); } else { showLoginScreen(); } };
  </script>
</body>
</html>
