<!doctype html>
<html lang="pt-BR" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Laboratorio Maker</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { box-sizing: border-box; font-family: 'Inter', 'Segoe UI', sans-serif; }
    .toast { position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #10b981; }
    input:checked + .slider:before { transform: translateX(26px); }
    .progress-bar { width: 100%; background-color: #e2e8f0; border-radius: 999px; height: 8px; overflow: hidden; }
    .progress-fill { height: 100%; transition: width 0.3s ease; }
    .custom-scrollbar::-webkit-scrollbar { height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
    @media (max-width: 640px) {
        .min-h-full { padding: 12px 8px !important; }
        td, th { padding-left: 4px !important; padding-right: 4px !important; font-size: 13px !important; }
    }
    #student-list table { width: 98%; table-layout: auto; }
  </style>
</head>
<body class="h-full bg-slate-900">
  <div id="app" class="w-full h-full overflow-auto bg-gradient-to-br from-slate-900 to-slate-800"></div>

  <script>
    // --- CONFIGURA√á√ÉO SUPABASE ---
    const SUPABASE_URL = 'https://nuhkdkiukqrlhdvnaiel.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_2Rd5khY_SUm3vBA3u5ZsHw_ps50tcTK';
    const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- ESTADO GLOBAL ---
    let allStudents = [];
    let allAttendances = [];
    let filteredStudents = [];
    let isAuthenticated = false;
    let currentUser = 'admin';
    let currentScreen = 'management';
    let selectedDate = new Date();
    selectedDate.setHours(12, 0, 0, 0); 
    let selectedStudentsForAssign = new Set();

    const defaultConfig = {
      page_title: "Laborat√≥rio Maker",
      filter_title: "Filtros",
      student_list_title: "Lista de Alunos",
      background_color: "#0f172a",
      card_color: "#1e293b",
      primary_button_color: "#3b82f6",
      font_size: 16
    };

    // --- CARREGAMENTO DE DADOS ---
    async function refreshData() {
        showToast("Sincronizando...", "info");
        let allFetchedStudents = [];
        let page = 0;
        const pageSize = 1000;
        let lastCount = 0;

        do {
            const { data, error } = await _supabase.from('students').select('*').range(page * pageSize, (page + 1) * pageSize - 1);
            if (error) break;
            allFetchedStudents = allFetchedStudents.concat(data);
            lastCount = data.length;
            page++;
        } while (lastCount === pageSize);

        let allFetchedAttendance = [];
        page = 0;
        do {
            const { data, error } = await _supabase.from('attendance').select('*').range(page * pageSize, (page + 1) * pageSize - 1);
            if (error) break;
            allFetchedAttendance = allFetchedAttendance.concat(data);
            lastCount = data.length;
            page++;
        } while (lastCount === pageSize);

        allStudents = allFetchedStudents;
        allAttendances = allFetchedAttendance;

        if (currentScreen === 'management') {
            updateFilterOptions('management');
            applyFilters();
        } else {
            updateFilterOptions('attendance');
            applyAttendanceFilters();
        }
    }

    // --- INTERFACE: LOGIN ---
    function showLoginScreen() {
      const config = defaultConfig;
      document.getElementById('app').innerHTML = `
        <div class="w-full h-full flex items-center justify-center">
          <div class="rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 bg-slate-800 border border-slate-700">
            <div class="text-center mb-8">
              <h1 class="text-3xl font-bold mb-2 text-white">Maker Lab</h1>
              <p class="text-slate-400">Digite o c√≥digo de acesso</p>
            </div>
            <form id="login-form" class="space-y-6">
              <input type="password" id="access-code" inputmode="numeric" required class="w-full p-4 border-2 border-slate-600 bg-slate-900 rounded-lg text-center text-2xl text-white">
              <button type="submit" class="w-full py-4 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-500">Acessar</button>
            </form>
            <div id="login-error" class="hidden mt-4 p-3 rounded-lg text-center bg-red-500/20 text-red-400">C√≥digo inv√°lido.</div>
          </div>
        </div>`;

      document.getElementById('login-form').onsubmit = async (e) => {
        e.preventDefault();
        if(document.getElementById('access-code').value === '123456') {
            isAuthenticated = true;
            sessionStorage.setItem('isAuth', 'true');
            await refreshData();
            renderManagementScreen();
        } else {
            document.getElementById('login-error').classList.remove('hidden');
        }
      };
    }

    // --- INTERFACE: HEADER ---
    function renderNavigationHeader() {
      return `
        <header class="mb-8">
          <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-white">${defaultConfig.page_title}</h1>
            <button onclick="handleLogout()" class="px-4 py-2 rounded-lg bg-slate-700 text-white">Sair</button>
          </div>
          <div class="flex gap-2">
            <button onclick="switchScreen('management')" class="flex-1 py-3 rounded-lg font-bold ${currentScreen === 'management' ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-400'}">Gerenciamento</button>
            <button onclick="switchScreen('attendance')" class="flex-1 py-3 rounded-lg font-bold ${currentScreen === 'attendance' ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-400'}">Frequ√™ncia</button>
          </div>
        </header>`;
    }

    function switchScreen(s) {
        currentScreen = s;
        if(s === 'management') renderManagementScreen();
        else renderAttendanceScreen();
    }

    // --- TELAS ---
    function renderManagementScreen() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="p-4 md:p-8 max-w-7xl mx-auto">
          ${renderNavigationHeader()}
          <div class="grid gap-6">
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                <h2 class="text-white font-bold mb-4">Planilha Excel</h2>
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="file" id="excel-upload" accept=".xlsx,.xls" class="flex-1 p-2 bg-slate-900 border border-slate-600 text-slate-400 rounded">
                    <button onclick="handleExcelUpload()" id="upload-btn" class="bg-blue-600 text-white px-6 py-2 rounded font-bold">Importar</button>
                </div>
                <div id="import-progress" class="hidden mt-4">
                    <div class="progress-bar"><div id="progress-fill" class="progress-fill bg-blue-500" style="width: 0%"></div></div>
                    <p id="progress-text" class="text-slate-400 text-xs mt-2 text-center">Processando...</p>
                </div>
            </div>
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    ${renderFilterSelects('management')}
                </div>
                <input type="text" id="search-nome" oninput="applyFilters()" placeholder="Buscar aluno..." class="w-full p-3 bg-slate-900 border border-slate-600 text-white rounded">
            </div>
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-white font-bold">Alunos (<span id="student-count">0</span>)</h2>
                    <div class="flex gap-2">
                        <button onclick="openAddModal()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm">Adicionar</button>
                        <button onclick="openAssignRoomModal()" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm">Atribuir</button>
                        <button onclick="deleteAllStudents()" class="bg-red-900 text-red-200 px-4 py-2 rounded text-sm">Limpar</button>
                    </div>
                </div>
                <div id="student-list" class="overflow-x-auto custom-scrollbar"></div>
            </div>
          </div>
        </div>
        ${renderModals()}`;
      updateFilterOptions('management');
      applyFilters();
    }

    function renderAttendanceScreen() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="p-4 md:p-8 max-w-7xl mx-auto">
          ${renderNavigationHeader()}
          <div class="grid gap-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                    <label class="text-slate-400 text-xs block mb-2">Data Selecionada</label>
                    <input type="date" id="date-input-picker" value="${selectedDate.toISOString().split('T')[0]}" onchange="updateDateFromPicker(this.value)" class="w-full p-3 bg-blue-600 text-white rounded font-bold">
                </div>
                <div class="md:col-span-2 bg-slate-800 p-6 rounded-xl border border-slate-700">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        ${renderFilterSelects('attendance')}
                    </div>
                </div>
            </div>
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                <h2 class="text-white font-bold mb-4 text-xl text-center">Lista de Frequ√™ncia (<span id="attendance-count">0</span>)</h2>
                <div id="attendance-list" class="space-y-3"></div>
            </div>
          </div>
        </div>`;
      updateFilterOptions('attendance');
      applyAttendanceFilters();
    }

    // --- LOGICA DE FILTROS ---
    function renderFilterSelects(context) {
        const prefix = context === 'management' ? 'filter' : 'attendance-filter';
        return `
            <div><label class="text-slate-400 text-xs">Sede</label><select id="${prefix}-sede" onchange="apply${context === 'management' ? '' : 'Attendance'}Filters()" class="w-full p-2 bg-slate-900 text-white border border-slate-600 rounded"><option value="todos">Todas</option></select></div>
            <div><label class="text-slate-400 text-xs">S√©rie</label><select id="${prefix}-serie" onchange="apply${context === 'management' ? '' : 'Attendance'}Filters()" class="w-full p-2 bg-slate-900 text-white border border-slate-600 rounded"><option value="todos">Todas</option></select></div>
            <div><label class="text-slate-400 text-xs">Turma</label><select id="${prefix}-turno" onchange="apply${context === 'management' ? '' : 'Attendance'}Filters()" class="w-full p-2 bg-slate-900 text-white border border-slate-600 rounded"><option value="todos">Todas</option></select></div>
            ${context === 'management' ? `<div><label class="text-slate-400 text-xs">Lado</label><select id="filter-parte-sala" onchange="applyFilters()" class="w-full p-2 bg-slate-900 text-white border border-slate-600 rounded"><option value="todos">Todos</option><option value="A">Lado A</option><option value="B">Lado B</option></select></div>` : ''}`;
    }

    function applyFilters() {
        const sede = document.getElementById('filter-sede')?.value || 'todos';
        const serie = document.getElementById('filter-serie')?.value || 'todos';
        const turma = document.getElementById('filter-turno')?.value || 'todos';
        const search = document.getElementById('search-nome')?.value.toLowerCase() || '';

        filteredStudents = allStudents.filter(s => {
            const mSede = sede === 'todos' || s.sede === sede;
            const mSerie = serie === 'todos' || s.serie === serie;
            const mTurma = turma === 'todos' || s.nome_turma === turma;
            const mSearch = s.nome_aluno.toLowerCase().includes(search);
            return mSede && mSerie && mTurma && mSearch;
        });
        renderStudentList();
    }

    function applyAttendanceFilters() {
        const s = document.getElementById('attendance-filter-sede')?.value || 'todos';
        const e = document.getElementById('attendance-filter-serie')?.value || 'todos';
        const t = document.getElementById('attendance-filter-turno')?.value || 'todos';
        const dKey = selectedDate.toISOString().split('T')[0];

        const list = allStudents.filter(x => {
            return (s === 'todos' || x.sede === s) && (e === 'todos' || x.serie === e) && (t === 'todos' || x.nome_turma === t);
        });

        document.getElementById('attendance-count').innerText = list.length;
        const cont = document.getElementById('attendance-list');
        
        cont.innerHTML = list.map(x => {
            const att = allAttendances.find(a => a.ra === x.ra && a.data_presenca === dKey);
            const present = att ? att.presente : true;
            return `
                <div class="bg-slate-900 p-4 rounded border border-slate-700 flex justify-between items-center">
                    <div><p class="text-white font-bold">${x.nome_aluno}</p><p class="text-slate-500 text-xs">${x.nome_turma}</p></div>
                    <label class="switch"><input type="checkbox" onchange="togglePresence('${x.ra}', this.checked)" ${present ? 'checked' : ''}><span class="slider"></span></label>
                </div>`;
        }).join('');
    }

    // --- FUN√á√ïES DE A√á√ÉO ---
    async function handleExcelUpload() {
      const file = document.getElementById('excel-upload').files[0];
      if (!file) return;
      
      const btn = document.getElementById('upload-btn');
      const prog = document.getElementById('import-progress');
      const fill = document.getElementById('progress-fill');
      const txt = document.getElementById('progress-text');

      btn.disabled = true;
      prog.classList.remove('hidden');

      const reader = new FileReader();
      reader.onload = async (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

        for (let i = 0; i < jsonData.length; i++) {
          const row = jsonData[i];
          const student = {
            sede: String(row.SEDE || ''),
            serie: String(row.SERIE || ''),
            nome_turma: String(row.NOME_TURMA || ''),
            ra: String(row.RA || ''),
            nome_aluno: String(row.NOME_ALUNO || ''),
            usuario: currentUser
          };
          await _supabase.from('students').upsert(student, { onConflict: 'ra' });
          const pct = Math.round(((i + 1) / jsonData.length) * 100);
          fill.style.width = pct + "%";
          txt.innerText = `${i+1} de ${jsonData.length}`;
        }
        await refreshData();
        btn.disabled = false;
        prog.classList.add('hidden');
      };
      reader.readAsArrayBuffer(file);
    }

    async function togglePresence(ra, val) {
        const dKey = selectedDate.toISOString().split('T')[0];
        const student = allStudents.find(x => x.ra === ra);
        if (!student) return;

        const { error } = await _supabase.from('attendance').upsert({
            ra: ra, data_presenca: dKey, presente: val, nome_aluno: student.nome_aluno, nome_turma: student.nome_turma, usuario: currentUser
        }, { onConflict: 'ra,data_presenca' });

        if (!error) {
            const idx = allAttendances.findIndex(a => a.ra === ra && a.data_presenca === dKey);
            if (idx !== -1) allAttendances[idx].presente = val;
            else allAttendances.push({ ra, data_presenca: dKey, presente: val });
            showToast(val ? "Presente" : "Ausente", "success");
        }
    }

    async function deleteStudent(id) {
        if(!confirm("Excluir aluno?")) return;
        const { error } = await _supabase.from('students').delete().eq('id', id);
        if(!error) refreshData();
    }

    async function handleStudentSubmit(e) {
        e.preventDefault();
        const student = {
            nome_aluno: document.getElementById('m-nome').value,
            ra: document.getElementById('m-ra').value,
            sede: document.getElementById('m-sede').value,
            serie: document.getElementById('m-serie').value,
            nome_turma: document.getElementById('m-turma').value,
            parte_sala: document.getElementById('m-parte').value,
            grupo: document.getElementById('m-grupo').value,
            usuario: currentUser
        };
        const { error } = await _supabase.from('students').upsert(student, { onConflict: 'ra' });
        if(!error) { closeStudentModal(); refreshData(); }
    }

    // --- MODAIS E LISTAS ---
    function renderStudentList() {
        const cont = document.getElementById('student-list');
        if(!cont) return;
        document.getElementById('student-count').innerText = filteredStudents.length;

        cont.innerHTML = `
            <table class="w-full text-white">
                <thead class="bg-slate-900">
                    <tr><th class="p-3 text-left">Nome</th><th class="p-3 text-left">Turma</th><th class="p-3 text-center">A√ß√µes</th></tr>
                </thead>
                <tbody>
                    ${filteredStudents.sort((a,b)=>a.nome_aluno.localeCompare(b.nome_aluno)).map(s => `
                        <tr class="border-b border-slate-700">
                            <td class="p-3">${s.nome_aluno}</td><td class="p-3 text-xs">${s.nome_turma}</td>
                            <td class="p-3 text-center">
                                <button onclick="openEditModal('${s.ra}')" class="text-blue-400 mr-2">‚úèÔ∏è</button>
                                <button onclick="deleteStudent('${s.id}')" class="text-red-400">üóëÔ∏è</button>
                            </td>
                        </tr>`).join('')}
                </tbody>
            </table>`;
    }

    function renderModals() {
        return `
        <div id="student-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70">
            <div class="bg-slate-800 p-6 rounded-xl w-full max-w-lg border border-slate-600 text-white">
                <h3 id="modal-title" class="text-xl font-bold mb-4">Aluno</h3>
                <form id="student-form" class="grid grid-cols-2 gap-4">
                    <div class="col-span-2"><label class="text-xs">Nome</label><input id="m-nome" class="w-full p-2 bg-slate-900 border border-slate-600 rounded"></div>
                    <div><label class="text-xs">RA</label><input id="m-ra" class="w-full p-2 bg-slate-900 border border-slate-600 rounded"></div>
                    <div><label class="text-xs">Sede</label><input id="m-sede" class="w-full p-2 bg-slate-900 border border-slate-600 rounded"></div>
                    <div><label class="text-xs">S√©rie</label><input id="m-serie" class="w-full p-2 bg-slate-900 border border-slate-600 rounded"></div>
                    <div><label class="text-xs">Turma</label><input id="m-turma" class="w-full p-2 bg-slate-900 border border-slate-600 rounded"></div>
                    <div><label class="text-xs">Lado</label><select id="m-parte" class="w-full p-2 bg-slate-900 border border-slate-600 rounded"><option value="">-</option><option value="A">A</option><option value="B">B</option></select></div>
                    <div class="col-span-2 flex gap-2"><button type="submit" class="flex-1 bg-blue-600 py-2 rounded">Salvar</button><button type="button" onclick="closeStudentModal()" class="flex-1 bg-slate-700 py-2 rounded">Cancelar</button></div>
                    <input type="hidden" id="m-grupo">
                </form>
            </div>
        </div>
        <div id="assign-room-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80">
            <div class="bg-slate-800 p-6 rounded-xl w-full max-w-lg border border-slate-600 text-white">
                <h3 class="font-bold mb-4">Atribui√ß√£o em Massa</h3>
                <div id="assign-list" class="max-h-60 overflow-y-auto bg-slate-900 p-2 rounded mb-4"></div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="massAssign('parte_sala', 'A')" class="bg-blue-600 p-2 rounded">Lado A</button>
                    <button onclick="massAssign('parte_sala', 'B')" class="bg-blue-600 p-2 rounded">Lado B</button>
                </div>
                <button onclick="closeAssignRoomModal()" class="w-full mt-4 bg-slate-600 p-2 rounded">Fechar</button>
            </div>
        </div>`;
    }

    // --- UTILIT√ÅRIOS FINAIS ---
    function openAddModal() {
        document.getElementById('modal-title').innerText = "Adicionar Aluno";
        document.getElementById('student-form').reset();
        document.getElementById('student-modal').classList.remove('hidden');
        document.getElementById('student-form').onsubmit = handleStudentSubmit;
    }

    function openEditModal(ra) {
        const s = allStudents.find(x => x.ra === ra);
        if(!s) return;
        document.getElementById('m-nome').value = s.nome_aluno;
        document.getElementById('m-ra').value = s.ra;
        document.getElementById('m-sede').value = s.sede;
        document.getElementById('m-serie').value = s.serie;
        document.getElementById('m-turma').value = s.nome_turma;
        document.getElementById('m-parte').value = s.parte_sala || '';
        document.getElementById('student-modal').classList.remove('hidden');
        document.getElementById('student-form').onsubmit = handleStudentSubmit;
    }

    async function massAssign(field, value) {
        const ids = Array.from(selectedStudentsForAssign);
        if(ids.length === 0) return alert("Selecione alunos!");
        await _supabase.from('students').update({ [field]: value }).in('id', ids);
        selectedStudentsForAssign.clear();
        closeAssignRoomModal();
        refreshData();
    }

    function openAssignRoomModal() {
        const cont = document.getElementById('assign-list');
        cont.innerHTML = filteredStudents.map(s => `
            <div class="flex items-center gap-2 p-1 border-b border-slate-700">
                <input type="checkbox" onchange="this.checked ? selectedStudentsForAssign.add('${s.id}') : selectedStudentsForAssign.delete('${s.id}')">
                <span class="text-xs">${s.nome_aluno}</span>
            </div>`).join('');
        document.getElementById('assign-room-modal').classList.remove('hidden');
    }

    function updateFilterOptions(ctx) {
        const prefix = ctx === 'management' ? 'filter' : 'attendance-filter';
        const sedes = [...new Set(allStudents.map(s => s.sede))].sort();
        const series = [...new Set(allStudents.map(s => s.serie))].sort();
        const turmas = [...new Set(allStudents.map(s => s.nome_turma))].sort();

        const pop = (id, list) => {
            const el = document.getElementById(prefix + id);
            if(el) el.innerHTML = '<option value="todos">Todas</option>' + list.map(x => `<option value="${x}">${x}</option>`).join('');
        };
        pop('-sede', sedes); pop('-serie', series); pop('-turno', turmas);
    }

    async function updateDateFromPicker(val) {
        const [y, m, d] = val.split('-').map(Number);
        selectedDate = new Date(y, m - 1, d, 12, 0, 0);
        await refreshData();
    }

    function closeStudentModal() { document.getElementById('student-modal').classList.add('hidden'); }
    function closeAssignRoomModal() { document.getElementById('assign-room-modal').classList.add('hidden'); }
    function handleLogout() { sessionStorage.clear(); location.reload(); }
    function showToast(m, t) {
        const toast = document.createElement('div');
        toast.className = `toast ${t === 'success' ? 'bg-green-600' : 'bg-blue-600'} text-white`;
        toast.innerText = m;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    window.onload = () => {
        if(sessionStorage.getItem('isAuth') === 'true') {
            isAuthenticated = true;
            refreshData().then(() => renderManagementScreen());
        } else {
            showLoginScreen();
        }
    };
  </script>
</body>
</html>
