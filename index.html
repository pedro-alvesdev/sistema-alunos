<!doctype html>
<html lang="pt-BR" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciador de Alunos</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* MANTENDO TODO O SEU CSS ORIGINAL */
    body { box-sizing: border-box; font-family: 'Inter', 'Segoe UI', sans-serif; }
    .toast { position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #10b981; }
    input:checked + .slider:before { transform: translateX(26px); }
    .calendar-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 10px; }
    .calendar-day { padding: 10px; text-align: center; cursor: pointer; border-radius: 6px; transition: all 0.2s; }
    .calendar-day:hover { background-color: #f3f4f6; }
    .calendar-day.selected { background-color: #6366f1; color: white; font-weight: bold; }
    .calendar-day.today { border: 2px solid #6366f1; }
    .progress-bar { width: 100%; background-color: #e2e8f0; border-radius: 999px; height: 8px; overflow: hidden; }
    .progress-fill { height: 100%; transition: width 0.3s ease; }
    .modal-backdrop { background-color: rgba(0,0,0,0.5); }
  </style>
</head>
<body class="h-full">
  <div id="app" class="w-full h-full overflow-auto bg-gradient-to-br from-indigo-50 to-blue-50"></div>

  <script>
    // CONFIGURA√á√ÉO SUPABASE - COLOQUE SEUS DADOS AQUI
    const SUPABASE_URL = 'https://nuhkdkiukqrlhdvnaiel.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_2Rd5khY_SUm3vBA3u5ZsHw_ps50tcTK';
    // O jeito correto de iniciar o Supabase no navegador:
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Vari√°veis de Estado (Mantidas as mesmas do original)
    let allStudents = [];
    let allAttendances = [];
    let filteredStudents = [];
    let filteredAttendances = [];
    let editingStudent = null;
    let isAuthenticated = false;
    let currentUser = 'admin';
    let currentScreen = 'management';
    let selectedDate = new Date();
    let selectedStudentsForAssign = new Set();
    let importErrors = [];

    // Configura√ß√£o de Visual (Mantida do Canva)
    const config = {
      page_title: "Gerenciador de Alunos de Laborat√≥rio",
      filter_title: "Filtros",
      student_list_title: "Lista de Alunos",
      background_color: "#0f172a",
      card_color: "#1e293b",
      text_color: "#e2e8f0",
      primary_button_color: "#3b82f6",
      secondary_button_color: "#475569",
      font_size: 16
    };

    // --- FUN√á√ïES DE DADOS (MIGRADAS PARA SUPABASE) ---

    async function fetchData() {
        const { data: students } = await supabase.from('students').select('*');
        const { data: attendance } = await supabase.from('attendance').select('*');
        allStudents = students || [];
        allAttendances = attendance || [];
        
        if (currentScreen === 'management') {
            applyFilters();
        } else {
            applyAttendanceFilters();
        }
    }

    // Inicializa√ß√£o
    async function initializeApp() {
      const savedAuth = sessionStorage.getItem('isAuthenticated');
      if (savedAuth === 'true') {
        isAuthenticated = true;
        await fetchData();
        renderCurrentScreen();
      } else {
        showLoginScreen();
      }
    }

    // --- MANTENDO TODAS AS FUN√á√ïES DE INTERFACE DO ORIGINAL ---
    // (Abaixo seguem as fun√ß√µes de renderiza√ß√£o exatamente como no seu c√≥digo)

    function showLoginScreen() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="w-full h-full flex items-center justify-center" style="background: linear-gradient(135deg, ${config.background_color}, ${adjustColor(config.background_color, 20)})">
          <div class="rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4" style="background-color: ${config.card_color}">
            <div class="text-center mb-8">
               <h1 class="font-bold mb-2 text-white" style="font-size: 28px;">Acesso Restrito</h1>
               <p class="text-gray-400">Digite o c√≥digo para continuar</p>
            </div>
            <form id="login-form" class="space-y-6">
              <input type="password" id="access-code" required maxlength="6" class="w-full p-4 border-2 rounded-lg text-center text-2xl" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
              <button type="submit" class="w-full py-4 rounded-lg font-semibold text-white bg-blue-600">üîì Acessar Sistema</button>
            </form>
            <div id="login-error" class="hidden mt-4 p-3 rounded-lg text-center bg-red-100 text-red-600">‚ùå C√≥digo inv√°lido.</div>
          </div>
        </div>`;

      document.getElementById('login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        if (document.getElementById('access-code').value === '123456') {
          isAuthenticated = true;
          sessionStorage.setItem('isAuthenticated', 'true');
          fetchData().then(() => renderCurrentScreen());
        } else {
          document.getElementById('login-error').classList.remove('hidden');
        }
      });
    }

    // ... (Aqui voc√™ deve colar as demais fun√ß√µes de renderiza√ß√£o: renderManagementScreen, renderAttendanceScreen, applyFilters, etc.)
    // Note: Para economizar espa√ßo aqui, as fun√ß√µes CRUD foram adaptadas abaixo:

    async function handleAddSubmit(e) {
      e.preventDefault();
      const newStudent = {
        nome_aluno: document.getElementById('add-nome-aluno').value,
        ra: document.getElementById('add-ra').value,
        sede: document.getElementById('add-sede').value,
        serie: document.getElementById('add-serie').value,
        turno: document.getElementById('add-turno').value,
        curso: document.getElementById('add-curso').value,
        nome_turma: document.getElementById('add-nome-turma').value,
        parte_sala: document.getElementById('add-parte-sala').value,
        grupo: document.getElementById('add-grupo').value
      };

      const { error } = await supabase.from('students').insert([newStudent]);
      if (!error) {
        showToast('Aluno adicionado!', 'success');
        await fetchData();
        closeAddModal();
      }
    }

    async function handleAttendanceChange(switchEl) {
      const ra = switchEl.dataset.studentRa;
      const isPresent = switchEl.checked;
      const dateKey = formatDateKey(selectedDate);
      const student = allStudents.find(s => s.ra === ra);

      const { error } = await supabase.from('attendance').upsert({ 
        ra: ra, 
        data_presenca: dateKey, 
        presente: isPresent,
        nome_aluno: student.nome_aluno,
        nome_turma: student.nome_turma
      }, { onConflict: 'ra,data_presenca' });

      if (!error) {
        showToast(isPresent ? '‚úÖ Presente' : '‚ùå Ausente', 'success');
        await fetchData();
      }
    }

    // Auxiliares (mantidas)
    function adjustColor(hex, percent) { /* ... mesma do original ... */ }
    function formatDate(date) { /* ... mesma do original ... */ }
    function showToast(msg, type) { /* ... mesma do original ... */ }

    initializeApp();
  </script>
</body>
</html>
